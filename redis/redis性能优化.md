## Redis内部的阻塞式操作

### redis的阻塞点

客户端：网络io，键值对增删改查操作，数据库操作

磁盘：生产RDB快照，记录AOF日志，AOF重写日志

主从节点：主库生产，传输RDB文件，从库接收RDB文件，清空数据库，加载RDB文件

切片数据库实例：向其他实例传输hash槽信息，数据迁移

#### 客户端阻塞点

网络IO：采用了IO多路复用,不会产生Io阻塞

操作阻塞：集合全量查询和聚合查询， 以及大批量数据删除内存链表回收阻塞（包括bigkey和清空数据库）。

#### 磁盘交互阻塞点

生产日志：由子进程来操作，不会产生阻塞

AOF日志：同步写模式会造成阻塞

#### 主从节点交互

从库加载RDB文件阻塞

从库FlUSHDB阻塞

#### 切片集群

Redis Cluster使用同步迁移，其中有bigkey就会造成阻塞

#### 总结阻塞点

* 集合全量查询和聚合操作；

* 从库加载 RDB 文件。

  

* bigkey 删除；

* 清空数据库；

* AOF 日志同步写；

其中

* bigkey 删除；
* 清空数据库；
* AOF 日志同步写；

这三个都可以通过异常子线程机制优化

#### 异步子线程

Redis 主线程启动后，会使用操作系统提供的 pthread_create 函数创建 3 个子线程，分别由它们负责 AOF 日志写操作、键值对删除以及文件关闭的异步执行。

![avatar](https://static001.geekbang.org/resource/image/ae/69/ae004728bfe6d3771c7424e4161e7969.jpg)

异步的键值对删除和数据库清空操作是 **Redis 4.0** 后提供的功能，Redis 也提供了新的命令来执行这两个操作。
键值对删除：当你的集合类型中有大量元素（例如有百万级别或千万级别元素）需要删除时，我建议你使用 UNLINK 命令。

清空数据库：可以在 FLUSHDB 和 FLUSHALL 命令后加上 ASYNC 选项，这样就可以让后台子线程异步地清空数据库，如下所示：

```
FLUSHDB ASYNC
FLUSHALL AYSNC
```



## CPU核和NUMA架构的影响



## Redis关键系统配置

## Redis内存碎片

## Redis 缓冲区



