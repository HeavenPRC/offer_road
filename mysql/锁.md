锁是为了并发访问时合理控制资源的访问

锁分为全局锁，表级锁和行锁

## 全局锁

 mysql全局锁就是对整个数据库加一个全局读锁

```
flush tables with read lock
```

加锁之后：数据更新语句，数据定义语句，更新类事务语句会被阻塞

### 使用场景：

全库逻辑备份

```
innodb可以使用mysqldump -single-transcation 导出之前会启动一个一致性事务。由于mvcc的支持过程中数据可以正常更新
```

还有一个全库只读的方法：set global readonly=true

不用这个原因是：

1. readonly的值会被用来做其他逻辑，比如用来判断一个库是不是从库.修改global的影响会更大
2. 异常处理机制上存在差异。如果执行FTWRL后，连接断开，mysql会自动释放锁。如果是global会一直保持这个状态



## 表级锁

mysql表级锁有两种：表锁，元数据锁

**表锁**的语法: lock tables ... read/write, 可以用unlock tables 主动释放锁。

```
需要注意的是lock table 不仅仅会限制别的线程的操作，也会限制当前线程的操作。
eg:lock tables t1 read, t2 write 就只能执行 读t1 read，读写t2 
```

**MDL** 不需要显式使用，当对一个表做增删改查操作的时候 加MDL读锁;当要对表结构变更操作时加MDL读锁

* 读锁之间不互斥，可以由多个线程同时对一张表增删改查
* 读写锁之间，写锁之间是互斥的

～～～

**注意不要因为MDL锁住正常的业务读**

给表加字段时要注意一个问题，如果是请求频繁的一个表，可能会因为MDL写锁请求，阻塞后面的读锁请求，又由于mysql的超时重试机制新起一个线程，导致库的线程爆满；

解决方法：

* 干掉长事务
* MariaDB AliSQl 在指定时间内请求MDL写锁，拿不到就放弃



## 行级锁

