### 利用重试机制维持操作成功的一致性

1. 可以把要删除的缓存值或者是要更新的数据库值暂存到消息队列中（例如使用 Kafka 消息队列）。

2. 当应用没有能够成功地删除缓存值或者是更新数据库值时，可以从消息队列中重新读取这些值，然后再次进行删除或更新。

3. 如果能够成功地删除或更新，我们就要把这些值从消息队列中去除，以免重复操作；

   否则的话，我们还需要再次进行重试。如果重试超过的一定次数，还是没有成功，我们就需要向业务层发送报错信息了。

### 先删除缓存再删除数据库

![avatar](https://static001.geekbang.org/resource/image/85/12/857c2b5449d9a04de6fe93yy1e355c12.jpg)

在线程 A 更新完数据库值以后，我们可以让它先 sleep 一小段时间，再进行一次缓存删除操作。

线程B先读写入缓存重新删除。

建议在业务程序运行的时候，统计下线程读数据和写缓存的操作时间，以此为基础来进行估算。

```
redis.delKey(X)
db.update(X)
Thread.sleep(N)
redis.delKey(X)
```

### 先更新数据库的值，再删除缓存值。

![avatar](https://static001.geekbang.org/resource/image/a1/0b/a1c66ee114yyc9f37f2a35f21b46010b.jpg)

